name: ğŸš€ Build and Deploy

# Activar el flujo solo cuando se cierre un pull request
# Ajuste segÃºn sus necesidades
on:
  pull_request:
    types:
      - closed
  push:
    branches:
      - feature/*

env:
  APP_DEPLOY_PATH: /home/ec2-user/app # Ruta en donde se desplegara la aplicaciÃ³n en su instancia de Lightsail (esta se creara mas adelante)

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ›’ Checkout Repository # Clonar los recursos del repo en el agente donde se ejecuta el pipeline
      uses: actions/checkout@v2

    - name: ğŸ“¦ Set up Node.js # Instalar nodejs version 18
      uses: actions/setup-node@v2
      with:
        node-version: 18

    - name: ğŸ“¥ Install Dependencies # Instalar las dependencias de la aplicaciÃ³n
      run: npm install

    # PodrÃ­a agregar aquÃ­ algunas tareas que ejecuten pruebas y anÃ¡lisis de cÃ³digo estÃ¡tico

    - name: ğŸ—ï¸ Build Application # Compilar la aplicaciÃ³n
      run: npm run build

    - name: ğŸ“¦ Package App # Empaquetar el compilado en un zip
      run: zip -r app.zip dist

    - name: ğŸšš Transfer App to Lightsail # transferir el archivo empaquetado a nuestra    instancia de Lightsail
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SSH_IP }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "./app.zip"
        target: ${{ env.APP_DEPLOY_PATH }}/

    - name: ğŸ“‚ Unzip App # Conectarse a la instancia de Lightsail y descomprimir la aplicaciÃ³n
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_IP }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          unzip -o ${{ env.APP_DEPLOY_PATH }}/app.zip -d /${{ env.APP_DEPLOY_PATH }}/
          ls -l

    - name: ğŸš€ Deploy App # Desplegar la aplicaciÃ³n, bello bello
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_IP }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd ${{ env.APP_DEPLOY_PATH }}/dist
          pm2 stop ./ecosystem.config.js
          yarn
          pm2 start ./ecosystem.config.js
